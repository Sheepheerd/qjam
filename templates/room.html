<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Stream Aggregator</title>
    <link rel="icon" href="/static/M.ico" type="image/x-icon" />

    <link rel="stylesheet" href="/static/room.css" />

    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="http://SortableJS.github.io/Sortable/Sortable.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div id="ambient-background">
      <div class="vignette"></div>
    </div>

    <header>
      <div class="header-controls-left">
        <button id="open-permissions-btn">
          Hi, {{ user.name }}!
        </button>
      </div>

      <div class="search-container">
        <div class="input-wrapper">
          <input
            type="text"
            id="url-input"
            name="query"
            placeholder="Search song..."
            autocomplete="off"
            hx-post="/search"
            hx-trigger="keyup changed delay:500ms"
            hx-target="#search-results"
          />
          <ul id="search-results" role="listbox"></ul>
        </div>
        <form
          hx-post="/{{ room.session_id }}/queue"
          hx-target="#input-wrapper"
          style="margin: 0; display: flex;"
        >
          <input type="hidden" name="url" id="hidden-submission-url" />
          <button
            type="submit"
            class="btn-add"
            onclick="document.getElementById('hidden-submission-url').value = document.getElementById('url-input').value"
          >
            Add
          </button>
        </form>
      </div>

      <div class="header-controls-right">
        <button id="open-dialog-btn">Invite</button>
      </div>
    </header>

    <main>
      <div class="art-column">
        <div id="now-playing-art">
          <div
            style="width: 100%; height: 100%; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center;"
          >
            <span style="font-size: 40px; opacity: 0.2">üéµ</span>
          </div>
        </div>

        <div id="main-info-area">
          <h1 id="main-title">Ready</h1>
          <h2 id="main-artist">Add a song to start</h2>
        </div>
      </div>

      <div class="queue-column">
        <div class="queue-header">
          <h3>Up Next</h3>
          <form
            hx-post="/play"
            hx-target="#player-container"
            hx-swap="innerHTML"
            style="margin: 0"
          >
            <button type="submit" class="btn-play-top">
              ‚ñ∂ Play Top
            </button>
          </form>
        </div>

        <div id="queue-scroll-area">
          <ul id="queue-list" hx-get="/{{ room.session_id }}/queue"></ul>
        </div>
        <div id="input-wrapper"></div>
      </div>
    </main>

    <div class="player-bar">
      <div id="player-container">
        <div style="color: #666; font-size: 0.9rem">No music playing</div>
      </div>
    </div>

    <dialog id="permissions-dialog">
        {% if user.host %}
        <span class="is-host-text"><h2>You are the host of the room!</h2></span>
        {% else %}
        <span class="is-guest-text"><h2>You are a guest of the room!</h2></span>
        {% endif %}
        
        <span class="can-queue-text">‚úÖ You can queue songs</span>
        <span class="can-order-queue-text">‚úÖ You can change the queue order</span>
        
        {% if user.host %}
        <span class="can-play-text">‚úÖ You can play songs</span>
        {% else %}
        <span class="cannot-play-text">‚ùå You cannot play songs</span>
        {% endif %}
        
        <button id="close-permissions-btn" class="close-btn">Close</button>
    </dialog>

    <dialog id="invite-dialog">
        <h2>Invite friends!</h2>
        <p><b>Code:</b> <span style="font-family: monospace; font-size: 1.1em;">{{ room.session_id }}</span></p>

        <div id="qrcode-wrapper" style="display: flex; justify-content: center; margin: 20px 0;">
            <div id="qrcode" style="padding: 15px; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);"></div>
        </div>
        
        <div id="user-list-container">
            {% for user in room.users %} 
                {% if user.host %}
                <span class="is-host-badge">{{ user.name }} (host)</span>
                {% else %}
                <span class="is-guest-badge">{{ user.name }} (guest)</span>
                {% endif %} 
            {% endfor %}
        </div>

        <br />
        <button id="close-dialog-btn" class="close-btn">Close</button>
    </dialog>

    <script>
      // Dialog Logic
      const permDialog = document.getElementById("permissions-dialog");
      const inviteDialog = document.getElementById("invite-dialog");

      document.getElementById("open-permissions-btn").onclick = () => permDialog.showModal();
      document.getElementById("close-permissions-btn").onclick = () => permDialog.close();

      document.getElementById("open-dialog-btn").onclick = () => {
          inviteDialog.showModal();
          const qrDiv = document.getElementById("qrcode");
          if(qrDiv.innerHTML.trim() === "") {
              new QRCode(qrDiv, {
                  text: `${window.location.origin}/join?code={{ room.session_id }}`,
                  width: 160,
                  height: 160,
                  colorDark : "#000000",
                  colorLight : "#ffffff",
                  correctLevel : QRCode.CorrectLevel.H
              });
          }
      };
      document.getElementById("close-dialog-btn").onclick = () => inviteDialog.close();

      // WebSocket Logic
      const roomId = "{{ room.session_id }}";
      const currentUserId = "{{ user.id }}";
      const isHost = {{ 'true' if user.host else 'false' }};
      const queueList = document.getElementById("queue-list");
      const socket = new WebSocket(`ws://${window.location.host}/ws/${roomId}`);

      socket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        renderQueue(data.queue);
        renderNowPlaying(data.now_playing);
        renderUsers(data.users);
      };

      async function deleteSong(songId) {
        if(!confirm("Remove song?")) return;
        try { await fetch(`/${roomId}/queue/${songId}`, { method: 'DELETE' }); }
        catch (e) { console.error(e); }
      }

      function renderUsers(users) {
        const userContainer = document.getElementById("user-list-container");
        if (!userContainer || !users) return;

        userContainer.innerHTML = "";

        users.forEach((user) => {
          const span = document.createElement("span");
          if (user.host) {
            span.className = "is-host-badge"; 
            span.textContent = `${user.name} (host)`;
          } else {
            span.className = "is-guest-badge"; 
            span.textContent = `${user.name} (guest)`;
          }
          userContainer.appendChild(span);
        });
      }

      function renderNowPlaying(song) {
        const artDiv = document.getElementById("now-playing-art");
        const titleEl = document.getElementById("main-title");
        const artistEl = document.getElementById("main-artist");
        const bg = document.getElementById("ambient-background");

        if (!song) {
          titleEl.innerText = "Ready";
          artistEl.innerText = "Add a song to start";
          artDiv.innerHTML = `<div style="width: 100%; height: 100%; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center;"><span style="font-size: 30px; opacity: 0.3">üéµ</span></div>`;
          return;
        }

        titleEl.innerText = song.title;
        artistEl.innerText = song.artist;

        if (song.album_art) {
           artDiv.innerHTML = `<img src="${song.album_art}" style="width:100%; height:100%; object-fit:cover;">`;
           bg.innerHTML = `<img src="${song.album_art}"><div class="vignette"></div>`;
        }
      }

      function renderQueue(queue) {
        queueList.innerHTML = "";
        queue.forEach(item => {
          const li = document.createElement("li");
          li.dataset.id = item.id;
          li.className = "queue-item";
          li.style.cssText = "display: flex; gap: 15px; align-items: center; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05);";

          const canDelete = isHost || (item.added_by_id === currentUserId);
          const delBtn = canDelete ? `<button class="btn-delete" onclick="deleteSong('${item.id}')" title="Remove">‚úï</button>` : '';

          li.innerHTML = `
            <img src="${item.album_art || 'https://placehold.co/60'}" style="width: 50px; height: 50px; border-radius: 6px; object-fit: cover;">
            <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.title}</div>
                <div style="font-size: 0.85rem; color: #aaa;">${item.artist || 'Unknown'}</div>
                <div style="font-size: 0.75rem; color: #666;">${item.added_by || 'System'}</div>
            </div>
            ${delBtn}
          `;
          queueList.appendChild(li);
        });
      }

      Sortable.create(queueList, {
          animation: 150,
          delay: 200, 
          delayOnTouchOnly: true,
          onEnd: () => {
              const order = Array.from(queueList.children).map(li => li.dataset.id);
              socket.send(JSON.stringify({ type: "reorder", order: order }));
          }
      });
    </script>
  </body>
</html>