<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Stream Aggregator</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    
    <style>
        /* CSS for Scrolling Container */
        .scrolling-queue {
            height: 200px;       /* Fixed height */
            overflow-y: auto;    /* Enable vertical scrolling */
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            background-color: #2b3035;
        }
    </style>
</head>
<body class="container">
    
    <h1>Audio Aggregator</h1>

    <form hx-post="/play" hx-target="#player-container" hx-swap="innerHTML">
        <label for="url">Paste YouTube URL:</label>
        <input type="text" name="url" placeholder="https://youtube.com/watch?v=..." required>
        <button type="submit">Play Stream</button>
    </form>

    <hr>

    <div id="player-container">
        <p>No audio playing.</p>
    </div>
    
    <div id="player-container"></div>

    <hr>

    <h3>Up Next</h3>
    
    <div id="queue-container" class="scrolling-queue">
        <p>Waiting for songs...</p>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function() {
        
        // 1. Helper function to read cookies
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // 2. Get the session ID from the cookie
        const sessionId = getCookie("session_id");
        const container = document.getElementById("queue-container");

        if (sessionId && container) {
            // 3. dynamically set the HTMX attributes
            // ENSURE THIS MATCHES YOUR BACKEND ROUTE (e.g. /queue/123 or /123/queue)
            container.setAttribute("hx-get", "/queue/" + sessionId);
            container.setAttribute("hx-trigger", "load");

            // 4. Manually trigger HTMX to process this new element
            htmx.process(container);
        } else {
            container.innerHTML = "<p>No active session found. Please join a room.</p>";
        }
    });
    </script>

    <form hx-post="/queue" hx-target="#queue-container" hx-swap="innerHTML">
        <label for="url">Add to Queue:</label>
        <div class="grid">
            <input type="text" name="url" placeholder="https://youtube.com/..." required>
            <button type="submit">Queue</button>
        </div>
    </form>

</body>
</html>